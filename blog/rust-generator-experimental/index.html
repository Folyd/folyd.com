<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1c45a5">
<link rel="stylesheet" href="/static/styles.css">
<link rel="stylesheet" href="/static/pygments.css">
<title>Rust 未来 Generator 语法探索之 Propane — Folyd</title>

<body>
<div class="page">
    <div class="header-navigator">
        <div id="menu-button">
            <svg width="24" height="24" viewBox="0 0 24 24" focusable="false" role="presentation">
                <path d="M5 15h14v2H5zm0-8h14v2H5zm0 4h14v2H5z" fill="currentColor" fill-rule="evenodd"></path>
            </svg>
        </div>
        <a href="/">
            <img src="/img/logo-white.svg" alt="folyd" style="height: 14px">
        </a>
    </div>

    <div class="navigator-container">
        <div class="navigator">
            <div id="close-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" focusable="false" role="presentation">
                    <path d="M12 10.586L6.707 5.293a1 1 0 0 0-1.414 1.414L10.586 12l-5.293 5.293a1 1 0 0 0 1.414 1.414L12 13.414l5.293 5.293a1 1 0 0 0 1.414-1.414L13.414 12l5.293-5.293a1 1 0 1 0-1.414-1.414L12 10.586z"
                          fill="currentColor">
                    </path>
                </svg>
            </div>
            <div class="menu has-background-primary">
                <a href="/">
                    <img src="/img/logo-white.svg" alt="folyd" style="margin:15px 0;height:12px;">
                </a>
                <nav class="nav">
                    
                    <a  class="active" 
                       href="/blog/" title="Blog - What I thought and wrote">
                        <img class="nav-image-item" src="/img/icon-blog.svg?h=8a78423e" alt="">
                    </a>
                    
                    <a 
                       href="/projects/" title="Projects - What I built and created">
                        <img class="nav-image-item" src="/img/icon-project.svg?h=033d057d" alt="">
                    </a>
                    
                    <a 
                       href="/about/" title="About - Who am I and how to contact me">
                        <img class="nav-image-item" src="/img/icon-about.svg?h=700c2d4e" alt="">
                    </a>
                    
                </nav>
            </div>
            
  
  
    <div class="tabs-container">
    <div class="tabs">
        <div class="tabs-menu">
            <span>
                <img src="/img/b.png?h=dfedffda" alt="" 
                     style="vertical-align: middle;margin-right:8px">
            </span>
            <span class="subtitle">Blog</span>
            <a href="feed.xml" title="Atom Feed" aria-label="Atom Feed" style="padding: 10px; vertical-align: middle; margin-left: auto;">
                <img src="/img/rss.svg" alt="RSS">
            </a>
        </div>
        <div class="tabs-list">
            
                
                    
                
                <a class="tabs-list-item" href="/blog/2022/">
                    我的 2022 总结
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/rust-pin-advanced/">
                    Rust Pin 进阶
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/rust-binary-search-pr/">
                    优化 Rust 标准库的 binary_search
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/rust-pin-unpin/">
                    Rust 的 Pin 与 Unpin
                </a>
            
                 
                    
                
                <a class="tabs-list-item active" href="/blog/rust-generator-experimental/">
                    Rust 未来 Generator 语法探索之 Propane
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/moonlit-sailor/">
                    Moonlit Sailor - 我的年度乐队
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/anyshortcut-cli-and-rust/">
                    发布 Anyshortcut CLI 版以及 Rust 使用半年之后的感受
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/the-origin-of-folyd/">
                    Folyd 的由来
                </a>
            
        </div>
    </div>
</div>
  

        </div>
    </div>


    <div class="body-container content">
        
        <div class="body text">
            
                <div class="heading">Rust 未来 Generator 语法探索之 Propane</div>
    
        <div style="font-size: 14px;color: #999;">
            -- 发布于 2020-08-07
        </div>
    
    <br>
    <h1 id="xian-zhuang">现状</h1><p>众所周知，Rust的Generator一直没有稳定，主要原因是Generator仍然有许多设计上的问题没有明确，所以无船同志写了一个名字叫<strong>Propane</strong>的新crate，旨在nightly上实验性的探索Rust Generator未来语法的可能性。</p>
<blockquote><p>Propane中文翻译：丙烷，无船同志取名向来看起来比较奇怪，不知道是否有其他用意</p>
</blockquote>
<p>目前nightly的generator只能写成闭包的形式（官方称作generator literal），比如这样：</p>
<div class="hll"><pre><span></span><span class="cp">#![feature(generators, generator_trait)]</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">yield</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;foo&quot;</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
<p>如果你写成这样的话：</p>
<div class="hll"><pre><span></span><span class="cp">#![feature(generators, generator_trait)]</span>

<span class="k">fn</span> <span class="nf">fake_generator</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span> <span class="p">{</span>
<span class="w">    </span><span class="kr">yield</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;foo&quot;</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fake_generator</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>编译器会报<a href="https://doc.rust-lang.org/nightly/error-index.html#E0627">E0627 A yield expression was used outside of the generator literal.</a>这个错。也就是目前的generator不支持以函数的方式写。</p>
<h1 id="propane">Propane</h1><p>前面说了，generator很多语法没有稳定甚至不支持，主要原因还是很多设计理念没有明确，所以Propane这个库先迈出了第一步。</p>
<div class="hll"><pre><span></span><span class="cp">#![feature(generators, generator_trait, try_trait)]</span>

<span class="cp">#[propane::generator]</span>
<span class="k">fn</span> <span class="nf">fizz_buzz</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">101</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">yield</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;FizzBuzz&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">yield</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Fizz&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">yield</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Buzz&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="p">(</span><span class="o">..</span><span class="p">)</span><span class="w">          </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">yield</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">fizz_buzz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fizz_buzz</span><span class="p">();</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;Fizz&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;4&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;Buzz&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;Fizz&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;7&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// yada yada yada</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">fizz_buzz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;98&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;Fizz&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;Buzz&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">fizz_buzz</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">is_none</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
<p>Propane提供了一个<code>generator</code>宏，可以让我们以函数的方式写Generator。当然Propane的主要目的是为了验证两个主要的设计理念是否合理：</p>
<ul>
<li><strong>1) 默认返回Iterator；return关键字可以终止generator，但只支持返回<code>()</code>; generator中的<code>?</code>表达式的默认行为和普通函数有差别</strong></li>
</ul>
<p>用Propane的<code>generator</code>宏标记的函数是一个返回<code>impl Iterator</code>的生成器，生成器中依然可以使用<code>return</code>关键字来终止，但是不能返回其他类型的值，只支持返回<code>()</code>。</p>
<p>生成器中支持<code>?</code>表达式，但是与普通函数中不同的是，如果生成器yield是一个<code>Result</code>类型，当<code>?</code>表达式碰到错误情况时会把错误yield出去，而不是return出去。然后在下一次resume直接退出生成器。</p>
<ul>
<li><strong>2) 不支持自引用(Self-referential)</strong></li>
</ul>
<p>async/await语法稳定的时候为了解决自引用的问题花了很大的心思设计Pin和Unpin等概念。如果Generator默认返回迭代器Iterator的话，我们依然会碰到了自引用的问题。因为<code>Iterator::next</code>在1.0就稳定了，我们不可能再去修改它的API来让迭代器支持自引用。如果不考虑性能，目前最简单粗暴的方法是可以把Generator的每个state装箱到堆上。</p>
<p>当然如果我们不支持自引用，就可以让generator支持零开销（zero cost），而且无船同志也大胆的推测（hypothesis）：也许我们确实不需要一个支持自引用的Generator。</p>
<p>最后，无船同志强调，这几个理念仅仅是实验性的，而且也有可能是一次失败的尝试。</p>
<p>以上是我了解完Propane之后结合无船的博客整理的文章，Propane的代码也很简洁，大家可以去<a href="https://github.com/withoutboats/propane">Github</a>查看。</p>
<p>链接：<a href="https://without.boats/blog/propane/">Propane: an experimental generator syntax for Rust</a></p>

            
        </div>
    </div>
    
    
    
    <div class="table-of-content">
        <div class="sticky">
            <b class="pipe-title">Table of content</b>
            <ul class="toc">
                
                <li>
                    <a href="#xian-zhuang">现状</a>
                    
                </li>
                
                <li>
                    <a href="#propane">Propane</a>
                    
                </li>
                
            </ul>
        </div>
    </div>
    
</div>
<script src="/static/app.js?h=f1487eff"></script>
</body>
