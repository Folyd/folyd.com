<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1c45a5">
<link rel="stylesheet" href="/static/styles.css">
<link rel="stylesheet" href="/static/pygments.css">
<title>Rust çš„ Pin ä¸ Unpin â€” Folyd</title>

<body>
<div class="page">
    <div class="header-navigator">
        <div id="menu-button">
            <svg width="24" height="24" viewBox="0 0 24 24" focusable="false" role="presentation">
                <path d="M5 15h14v2H5zm0-8h14v2H5zm0 4h14v2H5z" fill="currentColor" fill-rule="evenodd"></path>
            </svg>
        </div>
        <a href="/">
            <img src="/img/logo-white.svg" alt="folyd" style="height: 14px">
        </a>
    </div>

    <div class="navigator-container">
        <div class="navigator">
            <div id="close-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" focusable="false" role="presentation">
                    <path d="M12 10.586L6.707 5.293a1 1 0 0 0-1.414 1.414L10.586 12l-5.293 5.293a1 1 0 0 0 1.414 1.414L12 13.414l5.293 5.293a1 1 0 0 0 1.414-1.414L13.414 12l5.293-5.293a1 1 0 1 0-1.414-1.414L12 10.586z"
                          fill="currentColor">
                    </path>
                </svg>
            </div>
            <div class="menu has-background-primary">
                <a href="/">
                    <img src="/img/logo-white.svg" alt="folyd" style="margin:15px 0;height:12px;">
                </a>
                <nav class="nav">
                    
                    <a  class="active" 
                       href="/blog/" title="Blog - What I thought and wrote">
                        <img class="nav-image-item" src="/img/icon-blog.svg?h=8a78423e" alt="">
                    </a>
                    
                    <a 
                       href="/projects/" title="Projects - What I built and created">
                        <img class="nav-image-item" src="/img/icon-project.svg?h=033d057d" alt="">
                    </a>
                    
                    <a 
                       href="/about/" title="About - Who am I and how to contact me">
                        <img class="nav-image-item" src="/img/icon-about.svg?h=700c2d4e" alt="">
                    </a>
                    
                </nav>
            </div>
            
  
  
    <div class="tabs-container">
    <div class="tabs">
        <div class="tabs-menu">
            <span>
                <img src="/img/b.png?h=dfedffda" alt="" 
                     style="vertical-align: middle;margin-right:8px">
            </span>
            <span class="subtitle">Blog</span>
        </div>
        <div class="tabs-list">
            
                
                    
                
                <a class="tabs-list-item" href="/blog/rust-pin-advanced/">
                    Rust Pin è¿›é˜¶
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/rust-binary-search-pr/">
                    ä¼˜åŒ– Rust æ ‡å‡†åº“çš„ binary_search
                </a>
            
                 
                    
                
                <a class="tabs-list-item active" href="/blog/rust-pin-unpin/">
                    Rust çš„ Pin ä¸ Unpin
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/rust-generator-experimental/">
                    Rust æœªæ¥ Generator è¯­æ³•æ¢ç´¢ä¹‹ Propane
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/moonlit-sailor/">
                    Moonlit Sailor - æˆ‘çš„å¹´åº¦ä¹é˜Ÿ
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/anyshortcut-cli-and-rust/">
                    å‘å¸ƒ Anyshortcut CLI ç‰ˆä»¥åŠ Rust ä½¿ç”¨åŠå¹´ä¹‹åçš„æ„Ÿå—
                </a>
            
                
                    
                
                <a class="tabs-list-item" href="/blog/the-origin-of-folyd/">
                    Folyd çš„ç”±æ¥
                </a>
            
        </div>
    </div>
</div>
  

        </div>
    </div>


    <div class="body-container content">
        
        <div class="body text">
            
                <div class="heading">Rust çš„ Pin ä¸ Unpin</div>
    
        <div style="font-size: 14px;color: #999;">
            -- å‘å¸ƒäº2020-11-20
        </div>
    
    <br>
    <p>2019å¹´2æœˆ28å·ï¼ŒRust 1.33ç‰ˆå‘å¸ƒï¼Œå¢åŠ äº†æ–°çš„pinning APIï¼Œä¸»è¦åŒ…æ‹¬è¿™å‡ ä¸ªï¼š</p>
<ul>
<li><code>std::pin::Pin</code></li>
<li><code>std::marker::Unpin</code></li>
<li><code>std::marker::PhantomPinned</code></li>
<li><code>impl !Unpin for T</code></li>
</ul>
<p>åˆšå¼€å§‹æ¥è§¦è¿™äº›æ¦‚å¿µçš„æ—¶å€™æ„Ÿè§‰ç‰¹åˆ«ç»•ï¼Œæœ‰ç‚¹éš¾ç†è§£é€å½»ã€‚ç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘è®²<strong>Pin</strong>å’Œ<strong>Unpin</strong>çš„æ–‡ç« ï¼Œä½†æ€»æ„Ÿè§‰è®²å¾—ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šã€‚ç›´æ¥å»çœ‹<a href="https://doc.rust-lang.org/std/pin/index.html">std::pinæ¨¡å—</a>çš„æ–‡æ¡£ç†è§£èµ·æ¥ä¹ŸæŒºæœ‰éš¾åº¦çš„ã€‚æ‰€ä»¥è¿™ç¯‡æ–‡ç« æˆ‘å°†å°è¯•ç”±æµ…å…¥æ·±çš„æ¢³ç†ä¸€ä¸‹<strong>Pin</strong>å’Œ<strong>Unpin</strong>ï¼Œå¸Œæœ›èƒ½å¸®åŠ©å¤§å®¶ç†è§£è¿™äº›æ¦‚å¿µã€‚</p>
<h3 id="gai-nian">æ¦‚å¿µ</h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<strong>Pin</strong>å®˜æ–¹æ–‡æ¡£ä¸Šçš„å®šä¹‰ï¼š</p>
<div class="hll"><pre><span></span><span class="sd">/// A pinned pointer.</span>
<span class="sd">///</span>
<span class="sd">/// This is a wrapper around a kind of pointer which makes that pointer &quot;pin&quot; its</span>
<span class="sd">/// value in place, preventing the value referenced by that pointer from being moved</span>
<span class="sd">/// unless it implements [`Unpin`].</span>
<span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[lang = </span><span class="s">&quot;pin&quot;</span><span class="cp">]</span><span class="w"></span>
<span class="cp">#[fundamental]</span><span class="w"></span>
<span class="cp">#[repr(transparent)]</span><span class="w"></span>
<span class="cp">#[derive(Copy, Clone)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pointer</span>: <span class="nc">P</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">Deref</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Deref</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P</span>::<span class="n">Target</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">deref</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">P</span>::<span class="n">Target</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Pin</span>::<span class="n">get_ref</span><span class="p">(</span><span class="n">Pin</span>::<span class="n">as_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">DerefMut</span><span class="o">&lt;</span><span class="n">Target</span>: <span class="nb">Unpin</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">DerefMut</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">deref_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">P</span>::<span class="n">Target</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Pin</span>::<span class="n">get_mut</span><span class="p">(</span><span class="n">Pin</span>::<span class="n">as_mut</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>æˆ‘å…ˆæ¥ä»å®è§‚å±‚é¢è§£è¯»ä¸€ä¸‹ã€‚<strong>Pin</strong>æ˜¯ä¸€ä¸ªè¿™æ ·çš„æ™ºèƒ½æŒ‡é’ˆï¼Œä»–å†…éƒ¨åŒ…è£¹äº†å¦å¤–ä¸€ä¸ªæŒ‡é’ˆ<strong>P</strong>ï¼Œå¹¶ä¸”åªè¦<strong>P</strong>æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼ˆæˆ‘ä»¬ç§°ä¸º<strong>T</strong>ï¼‰æ²¡æœ‰å®ç°<strong>Unpin</strong>ï¼Œåˆ™å¯ä»¥ä¿è¯<strong>T</strong>æ°¸è¿œä¸ä¼šè¢«ç§»åŠ¨ï¼ˆmoveï¼‰ã€‚<strong>Pin</strong>è¿™ä¸ªå•è¯ä¹Ÿå¾ˆå½¢è±¡çš„è¡¨ç¤º<strong>Pin</strong>å°±åƒé’‰å­ä¸€æ ·å¯ä»¥æŠŠ<strong>T</strong>é’‰ä½ã€‚æ‰€ä»¥<strong>Pin</strong>ä¸€èˆ¬æ¥è¯´ç”¨<code>Pin&lt;P&lt;T&gt;&gt;</code>è¿™ç§æ–¹å¼è¡¨ç¤ºï¼ˆPæ˜¯Pointerçš„ç¼©å†™ï¼ŒTæ˜¯Typeçš„ç¼©å†™ï¼‰ã€‚è¿™ä¸ªå®šä¹‰åˆçœ‹æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æ¥åˆ’å‡ ä¸ªé‡ç‚¹ï¼š</p>
<ul>
<li><strong>Pin</strong>è‡ªèº«æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºä»–<strong>impl</strong>äº†<strong>Deref</strong>å’Œ<strong>DerefMut</strong>ã€‚</li>
<li><strong>Pin</strong>åŒ…è£¹çš„å†…å®¹åªèƒ½æ˜¯æŒ‡é’ˆï¼Œä¸èƒ½æ˜¯å…¶ä»–æ™®é€šç±»å‹ã€‚æ¯”å¦‚<code>Pin&lt;u32&gt;</code>å°±æ²¡æœ‰æ„ä¹‰ã€‚</li>
<li><strong>Pin</strong>å…·æœ‰â€œé’‰ä½â€<strong>T</strong>ä¸èƒ½ç§»åŠ¨çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯å¦ç”Ÿæ•ˆå–å†³äº<strong>T</strong>æ˜¯å¦<code>impl Unpin</code>ã€‚ç®€å•çš„è¯´ï¼Œå¦‚æœ<strong>T</strong>å®ç°äº†<strong>Unpin</strong>ï¼Œ<strong>Pin</strong>çš„â€œé’‰ä½â€åŠŸèƒ½å®Œå…¨å¤±æ•ˆäº†ï¼Œè¿™æ—¶å€™çš„<code>Pin&lt;P&lt;T&gt;&gt;</code>å°±ç­‰ä»·äº<code>P&lt;T&gt;</code>ã€‚</li>
<li><strong>Unpin</strong>æ˜¯ä¸€ä¸ªauto traitï¼Œç¼–è¯‘å™¨é»˜è®¤ä¼šç»™æ‰€æœ‰ç±»å‹å®ç°<strong>Unpin</strong>ã€‚å”¯ç‹¬æœ‰å‡ ä¸ªä¾‹å¤–ï¼Œä»–ä»¬å®ç°çš„æ˜¯<strong>!Unpin</strong>ã€‚è¿™å‡ ä¸ªä¾‹å¤–æ˜¯<strong>PhantomPinned</strong>ï¼Œç¼–è¯‘å™¨ä¸ºasync/await desugarä¹‹åç”Ÿæˆçš„<code>impl Future</code>çš„ç»“æ„ä½“ã€‚</li>
<li>æ‰€ä»¥<code>Pin&lt;P&lt;T&gt;&gt;</code>é»˜è®¤æƒ…å†µä¸‹çš„â€œé’‰ä½â€åŠŸèƒ½æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼Œåªé’ˆå¯¹ä¸Šé¢è¯´çš„è¿™å‡ ä¸ª<code>impl !Unpin</code>çš„æƒ…å†µç”Ÿæ•ˆã€‚</li>
</ul>
<p>çœ‹äº†è¿™å‡ æ¡å¯èƒ½è¿˜æœ‰ç‚¹æ‡µï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¼€å§‹é€æ¡å‰–æã€‚é¦–å…ˆè¦ææ¸…æ¥šçš„æ˜¯åˆ°åº•ä»€ä¹ˆæ˜¯moveä»¥åŠä¸ºä»€ä¹ˆæœ‰äº›æƒ…å†µæˆ‘ä»¬è¦é˜²æ­¢moveå‘ç”Ÿï¼Ÿ</p>
<h3 id="dao-di-shi-yao-shi-move">åˆ°åº•ä»€ä¹ˆæ˜¯moveï¼Ÿ</h3><p>æ ¹æ®å®˜æ–¹å®šä¹‰ï¼šæ‰€æœ‰æƒè½¬ç§»çš„è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯moveã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªå¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰çš„ä¾‹å­ï¼š</p>
<div class="hll"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span><span class="w"> </span><span class="c1">// s1çš„æ‰€æœ‰æƒè½¬ç§»ç»™äº†s2ï¼Œè¿™é‡Œå‘ç”Ÿäº†move</span>
<span class="w">  </span><span class="c1">// let s3 = s1; // s1çš„æ‰€æœ‰æƒä»¥åŠè½¬ç§»èµ°äº†ï¼Œä¸èƒ½å†moveï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼šerror[E0382]: use of moved value: `s1`</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>åŸºæœ¬æ¦‚å¿µè¿™é‡Œä¸å¤šè§£é‡Šäº†ï¼Œæˆ‘ä»¬éœ€è¦ææ˜ç™½çš„æ˜¯<code>let s2 = s1;</code>è¿™ä¸€è¡Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p><img src="https://doc.rust-lang.org/stable/book/img/trpl04-04.svg" alt=""></p>
<p>å€Ÿç”¨äº†TRPLä¹¦ä¸Šçš„è¿™å¼ å›¾ã€‚s1å’Œs2ä¸¤ä¸ªå˜é‡éƒ½æ˜¯åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ï¼Œå­—ç¬¦ä¸²â€œHelloâ€æ˜¯åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå…¶ä¸­ptrå­—æ®µå°±æ˜¯æŒ‡å‘è¯¥å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚moveå‘ç”Ÿçš„æ—¶å€™ç¼–è¯‘å™¨ä¼šåœ¨æ ˆä¸Šå¼€è¾Ÿä¸€å—æ–°å†…å­˜s2ï¼Œç„¶ååŸå°ä¸åŠ¨æŠŠs1æ ˆä¸Šçš„å†…å®¹æ‹·è´åˆ°s2ï¼Œéšå³ç«‹é©¬è®©åŸs1çš„å†…å­˜å¤±æ•ˆã€‚</p>
<p>å†çœ‹ä¸€ä¸ªmoveçš„åˆ—å­ï¼š</p>
<div class="hll"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;xxx&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;yyy&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="s">&quot;yyy&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="s">&quot;xxx&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>æˆ‘ä»¬é€šè¿‡<code>std::mem::swap()</code>æ–¹æ³•äº¤æ¢äº†ä¸¤ä¸ªå¯å˜å€Ÿç”¨<strong>&amp;mut</strong>çš„å†…å®¹ï¼Œè¿™é‡Œä¹Ÿå‘ç”Ÿäº†moveã€‚</p>
<p>åƒè¿™ä¸¤ç§moveåœ¨Rusté‡Œé¢å¾ˆç¨€æ¾å¹³å¸¸ï¼Œä½¿ç”¨èµ·æ¥ä¸æ¯«ä¸ä¼šå¼•å‘ä»€ä¹ˆé—®é¢˜ã€‚é‚£åˆ°åº•æ˜¯ä»€ä¹ˆæƒ…å†µéœ€è¦é˜²æ­¢moveçš„å‘ç”Ÿå‘¢ï¼Ÿ</p>
<p>è¿˜çœŸæœ‰ï¼Œé‚£å°±æ˜¯è‡ªå¼•ç”¨ç»“æ„ä½“ï¼</p>
<h3 id="zi-yin-yong-jie-gou-ti-de-move">è‡ªå¼•ç”¨ç»“æ„ä½“çš„move</h3><p>è‡ªå¼•ç”¨ç»“æ„ä½“ï¼ˆSelf-Referential Structsï¼‰æ˜¯ä¸€ä¸ªè¿™ä¸ªæ ·çš„ç»“æ„ä½“ï¼Œå®ƒå†…éƒ¨æŸä¸ªæˆå‘˜æ˜¯å¯¹å¦å¤–ä¸€ä¸ªæˆå‘˜çš„å¼•ç”¨ã€‚æ¯”å¦‚è¿™æ ·ï¼š</p>
<div class="hll"><pre><span></span><span class="k">struct</span> <span class="nc">Test</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="nc">a</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="c1">//    let _test = Test { a, b: &amp;a };</span>
<span class="c1">//  |                        -     ^^ value borrowed here after move</span>
<span class="c1">//  |                        |</span>
<span class="c1">//  |                        value moved here</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>ä½†äº‹å®ä¸Šæˆ‘ä»¬æ²¡åŠæ³•é€šè¿‡Safe Rustæ„é€ ä¸€ä¸ªåƒTestè¿™æ ·çš„è‡ªå¼•ç”¨ç»“æ„ä½“ï¼ŒRustç›®å‰å¯¹è‡ªå¼•ç”¨ç»“æ„ä½“æ”¯æŒè¿˜å¾ˆä¸å®Œå–„ã€‚åªèƒ½å˜é€šä¸€ä¸‹ä½¿ç”¨æŒ‡é’ˆï¼š</p>
<div class="hll"><pre><span></span><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// æ”¹æˆæŒ‡é’ˆ</span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">txt</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">a</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">b</span>: <span class="nc">std</span>::<span class="n">ptr</span>::<span class="n">null</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">self_ref</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self_ref</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">a</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">b</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;*</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">)}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>æˆ‘ä»¬æ¥è¯•ä¸€ä¸‹è¿™ä¸ªè‡ªå¼•ç”¨ç»“æ„ä½“çš„moveï¼š</p>
<div class="hll"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Test</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;test1&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">test1</span><span class="p">.</span><span class="n">init</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">test2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Test</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;test2&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">test2</span><span class="p">.</span><span class="n">init</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a: {}, b: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">a</span><span class="p">(),</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">b</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨swap()å‡½æ•°äº¤æ¢ä¸¤è€…ï¼Œè¿™é‡Œå‘ç”Ÿäº†move</span>
<span class="w">    </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">test1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">test2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">test1</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;I&#39;ve totally changed now!&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a: {}, b: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">a</span><span class="p">(),</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">b</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>è¿™æ˜¯æ‰“å°ç»“æœï¼š</p>
<pre><code>a: test1, b: test1
a: test1, b: I've totally changed now!
</code></pre>
<p>æœ‰æ²¡æœ‰å‘ç°ï¼Œå‡ºé—®é¢˜äº†ï¼é—®é¢˜å‡ºåœ¨å“ªï¼ŸåŸå› æ˜¯Testç»“æ„ä½“ä¸­çš„å­—æ®µbæ˜¯ä¸€ä¸ªæŒ‡å‘å­—æ®µaçš„æŒ‡é’ˆï¼Œå®ƒåœ¨æ ˆä¸Šå­˜çš„æ˜¯å­—æ®µaçš„åœ°å€ã€‚é€šè¿‡<code>swap()</code>å‡½æ•°äº¤æ¢ä¸¤ä¸ªTestç»“æ„ä½“ä¹‹åï¼Œå­—æ®µa,båˆ†åˆ«ç§»åŠ¨åˆ°å¯¹æ–¹çš„å†…å­˜åŒºåŸŸä¸Šï¼Œä½†æ˜¯aå’Œbæœ¬èº«çš„å†…å®¹æ²¡æœ‰å˜ã€‚ä¹Ÿå°±æ˜¯æŒ‡é’ˆbä¾ç„¶æŒ‡å‘çš„æ˜¯åŸæ¥çš„åœ°å€ï¼Œä½†æ˜¯è¿™ä¸ªåœ°å€ç°åœ¨å·²ç»å±äºå¦å¤–ä¸€ä¸ªç»“æ„ä½“äº†ï¼è¿™ä¸ä»…ä¸æ˜¯è‡ªå¼•ç”¨ç»“æ„ä½“äº†ï¼Œæ›´å¯æ€•çš„æ˜¯è¿™ä¸ªæŒ‡é’ˆå¯èƒ½å¯¼è‡´æ›´å±é™©çš„é—®é¢˜ï¼Œè¿™æ˜¯Rustå†³ä¸å…è®¸å‡ºç°çš„ï¼ğŸ‘‡ä¸‹é¢è¿™å¼ å›¾å¯ä»¥å¸®åŠ©ç†è§£ï¼š</p>
<p><img src="https://rust-lang.github.io/async-book/assets/swap_problem.jpg" alt=""></p>
<p>æ›´å…³é”®çš„æ˜¯Rustçš„Generatorå’Œasync/awaitè¿™ä¸€å¥—éƒ½æ˜¯åŸºäºè‡ªå¼•ç”¨ç»“æ„ä½“å®ç°çš„ã€‚å¦‚æœä¸èƒ½ä»æ ¹æºä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRustå·ç§°çš„Memory Safeçš„æ ¹åŸºå°±å®Œå…¨åŠ¨æ‘‡äº†ã€‚</p>
<blockquote><p>æ›´å¤šå…³äºasync/awaitçš„åŸç†ï¼Œå¼ºçƒˆæ¨èé˜…è¯»è¿™ä¸¤æœ¬ä¹¦ï¼š</p>
<ul>
<li><a href="https://rust-lang.github.io/async-book">https://rust-lang.github.io/async-book</a></li>
<li><a href="https://cfsamson.github.io/books-futures-explained">https://cfsamson.github.io/books-futures-explained</a></li>
</ul>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬æ¥æ‰¾ä¸€ä¸‹å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„æ ¹æºï¼Œç„¶åæƒ³åŠæ³•ä»æ ¹æºä¸Šè§£å†³å®ƒï¼</p>
<h3 id="gen-yuan-shi-shi-yao">æ ¹æºæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æˆ‘ä»¬å‘ç°ä¸Šé¢çš„ä¾‹å­æœ€å…³é”®çš„ä¸€è¡Œä»£ç æ˜¯<code>std::mem::swap(&amp;mut test1, &amp;mut test2)</code>ï¼Œå°±æ˜¯å®ƒå¯¼è‡´äº†æˆ‘ä»¬è‡ªå¼•ç”¨ç»“æ„ä½“å¤±æ•ˆå¼•å‘äº†å†…å­˜å®‰å…¨é—®é¢˜ã€‚æ‰€ä»¥æˆ‘ä»¬æ˜¯ä¸æ˜¯åªè¦é¿å…è¿™ä¸ª<code>swap()</code>å‡½æ•°åº”ç”¨åˆ°æˆ‘ä»¬è‡ªå¼•ç”¨ç»“æ„ä½“ä¸Šå°±è¡Œï¼Ÿå¯æ˜¯æ€ä¹ˆå»é¿å…å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>swap()</code>æ–¹æ³•çš„å®šä¹‰ï¼š</p>
<div class="hll"><pre><span></span><span class="cp">#[inline]</span><span class="w"></span>
<span class="cp">#[stable(feature = </span><span class="s">&quot;rust1&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.0.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">swap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// SAFETY: the raw pointers have been created from safe mutable references satisfying all the</span>
<span class="w">    </span><span class="c1">// constraints on `ptr::swap_nonoverlapping_one`</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ptr</span>::<span class="n">swap_nonoverlapping_one</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>å®ƒçš„å‚æ•°è¦æ±‚æ˜¯å¯å˜å€Ÿç”¨<strong>&amp;mut</strong>ï¼Œæ‰€ä»¥åªè¦æˆ‘ä»¬æƒ³åŠæ³•è®©Safe Rustä¸‹ä¸æš´éœ²å¯å˜å€Ÿç”¨å³å¯ï¼</p>
<p>è¿˜æ˜¯ä»¥Testä¸ºä¾‹ï¼Œå®ƒè‡ªèº«æ²¡åŠæ³•é™åˆ¶è‡ªå·±ä¸èƒ½å¯å˜å€Ÿç”¨ï¼Œå› ä¸ºæˆ‘ä»¬ç›´æ¥ç”¨<code>&amp;mut Test{...}</code>å°±å¯ä»¥è½»æ¾æ‹¿åˆ°ã€‚é‚£ä»æ ‡å‡†åº“ä¸­å»æ‰¾æ‰¾ï¼Œ<code>Box&lt;T&gt;</code>å‘¢ï¼Ÿå…ˆä¸è€ƒè™‘å®ƒæ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬æŠŠç»“æ„ä½“<strong>T</strong>åŒ…è£¹åœ¨<strong>Box</strong>ä¸­ï¼Œçœ‹<strong>Box</strong>èƒ½ä¸èƒ½ä¿è¯ä¸æš´éœ²<code>&amp;mut T</code>å‡ºå»ã€‚çœ‹ä¸€ä¸‹APIæ–‡æ¡£ï¼Œå¾ˆé—æ†¾ä¸èƒ½ã€‚<a href="https://doc.rust-lang.org/std/boxed/struct.Box.html#method.leak">Box::leak()</a>è¿”å›å€¼å°±æ˜¯<code>&amp;mut T</code>ï¼Œæ›´ç”šè€…<strong>Box</strong> <strong>impl</strong>äº†<strong>DerefMut</strong>ï¼Œå°±ç®—ä¸ç”¨<code>leak()</code>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>* &amp;mut Box&lt;T&gt;</code>è§£å¼•ç”¨è½»æ¾æ‹¿åˆ°<code>&amp;mut T</code>ï¼</p>
<p>ä¸ç”¨æ‰¾äº†ï¼Œåœ¨<strong>Pin</strong>ä¹‹å‰çš„æ ‡å‡†åº“ä¸­ç¡®å®æ²¡æœ‰è¿™æ ·çš„APIèƒ½å¤Ÿé˜²æ­¢åœ¨Safe Rustä¸‹ä¸æš´éœ²<code>&amp;mut T</code>ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æ˜¯è¯¥<strong>Pin</strong>ç™»åœºçš„æ—¶å€™äº†ï¼</p>
<h3 id="pinshan-liang-deng-chang">Piné—ªäº®ç™»åœº</h3><p>æˆ‘ä»¬æ‰¾åˆ°äº†é—®é¢˜çš„æ ¹æºåœ¨å“ªï¼Œ<strong>Pin</strong>å°±æ˜¯ä»æ ¹æºä¸Šè§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚ç°åœ¨æˆ‘ä»¬å¾ˆæ¸…æ™°äº†ï¼Œä¼¼ä¹æ˜¯ä¸æ˜¯å¯ä»¥ç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼š<strong>Pin</strong>å°±æ˜¯ä¸€ä¸ªä¸ä¼šè®©ä½ åœ¨Safe Rustæš´éœ²å¯å˜å€Ÿç”¨<strong>&amp;mut</strong>çš„æ™ºèƒ½æŒ‡é’ˆ?</p>
<p>ç­”æ¡ˆæ˜¯ï¼šä¸å…¨æ­£ç¡®ã€‚è¿™å°±æ˜¯<strong>Pin</strong>æ¦‚å¿µèµ·åˆè®©å¤§å®¶ä¸€è„¸æ‡µé€¼çš„åœ°æ–¹ã€‚ä¸‹é¢è®©<strong>Pin</strong>è‡ªå·±æ¥è§£ç­”å¤§å®¶çš„ç–‘æƒ‘ï¼Œ<strong>Pin</strong>è¯´ï¼šâ€œä½ ä»¬ä¸æ˜¯æƒ³è®©æˆ‘ä¿è¯è¢«æˆ‘åŒ…è£¹çš„æŒ‡é’ˆ<code>P&lt;T&gt;</code>æ°¸è¿œé’‰ä½ä¸è®©moveå—ï¼Ÿæˆ‘å¯ä»¥ç­”åº”ï¼Œä½†æˆ‘æœ‰ä¸€ä¸ªåŸåˆ™ã€‚é‚£å°±æ˜¯æˆ‘æ°¸è¿œä¸èƒ½é’‰ä½æŒæœ‰é€šè¡Œè¯çš„æœ‹å‹ï¼Œè¿™å¼ é€šè¡Œè¯å°±æ˜¯<strong>Unpin</strong>ã€‚å¦‚æœæ²¡æœ‰è¿™å¼ é€šè¡Œè¯ï¼Œè¯·æ”¾å¿ƒï¼Œæˆ‘ä¼šæŠŠä½ é’‰å¾—æ­»æ­»çš„ï¼â€</p>
<p>ä¸¾ä¸ªä¾‹å­ã€‚æ¯”å¦‚æˆ‘æ˜¯<code>Pin</code>ï¼Œä½ æ˜¯<code>P&lt;T&gt;</code>ï¼Œå¦‚æœä½ <strong>impl</strong>äº†<strong>Unpin</strong>ï¼Œæˆ‘ä¼šæä¾›ä¸¤ç§åŠæ³•è®©ä½ åœ¨Safe Rustä¸‹æ‹¿åˆ°<code>&amp;mut T</code>ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼Œä½¿ç”¨ï¼š<code>Pin::get_mut()</code></li>
</ul>
<div class="hll"><pre><span></span><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline(always)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_mut</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">T</span>: <span class="nb">Unpin</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">pointer</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<ul>
<li>ç¬¬äºŒç§ï¼Œæˆ‘<strong>impl</strong>äº†<strong>DerefMut</strong>ï¼Œä½ å¯ä»¥è§£å¼•ç”¨æ‹¿åˆ°<code>&amp;mut T</code></li>
</ul>
<div class="hll"><pre><span></span><span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">DerefMut</span><span class="o">&lt;</span><span class="n">Target</span>: <span class="nb">Unpin</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">DerefMut</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">deref_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">P</span>::<span class="n">Target</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Pin</span>::<span class="n">get_mut</span><span class="p">(</span><span class="n">Pin</span>::<span class="n">as_mut</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>å¯rustcçˆ¸çˆ¸å¤ªå®½å®¹äº†ï¼Œä»–é»˜è®¤ç»™ä½ ä»¬æ‰€æœ‰ç±»å‹å‘äº†é€šè¡Œè¯ï¼ˆéƒ½å®ç°äº†<strong>Unpin</strong>ï¼‰ï¼æå¾—æˆ‘éƒ½å‡ ä¹å¿«è¦å¤±ä¸šäº†ï¼</p>
<div class="hll"><pre><span></span><span class="cp">#[lang = </span><span class="s">&quot;unpin&quot;</span><span class="cp">]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="n">auto</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">Unpin</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Unpin</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Unpin</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">&quot;pin_raw&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.38.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Unpin</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">&quot;pin_raw&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.38.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Unpin</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
<p>å”¯ä¸€è®©æˆ‘æ¬£æ…°çš„æ˜¯ï¼Œä»–ç»™æˆ‘ç•™äº†ä¸€ä¸ªå«<strong>PhantomPinned</strong>çš„å°ä¼™ä¼´ã€‚åˆ«çœ‹ä»–åå­—å¾ˆå¥‡æ€ªï¼Œä»–å¯æ˜¯æˆ‘å¾ˆå–œæ¬¢çš„å¾—åŠ›åŠ©æ‰‹ï¼å› ä¸ºä»–å®ç°çš„æ˜¯<strong>!Unpin</strong>ï¼</p>
<div class="hll"><pre><span></span><span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[derive(Debug, Copy, Clone, Eq, PartialEq, Ord, PartialOrd, Hash)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PhantomPinned</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="nb">Unpin</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
<p>rustcçˆ¸çˆ¸è¿˜è¯´ï¼Œä½ ä»¬å¦‚æœæƒ³â€œæ”¹é‚ªå½’æ­£â€å»æ‰<strong>Unpin</strong>ä¹Ÿå¯ä»¥ï¼Œæœ‰ä¸¤ç§åŠæ³•ï¼š</p>
<ul>
<li><p>ä½¿ç”¨<strong>PhantomPinned</strong>ã€‚æœ‰äº†å®ƒï¼Œrustcçˆ¸çˆ¸ä¸ä¼šè®©ä½ å®ç°<strong>Unpin</strong>ã€‚</p>
<div class="hll"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="n">PhantomPinned</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">a</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">b</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">_marker</span>: <span class="nc">PhantomPinned</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p>ç»™è‡ªå·±æ‰‹åŠ¨<code>impl !Unpin</code>ã€‚å‰ææ˜¯ä½ è¦ä½¿ç”¨nightlyç‰ˆæœ¬ï¼Œå¹¶ä¸”éœ€è¦å¼•å…¥<strong>#![feature(negative_impls)]</strong>ï¼š</p>
</li>
</ul>
<div class="hll"><pre><span></span><span class="cp">#![feature(negative_impls)]</span><span class="w"></span>
<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="nb">Unpin</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
<p>æ»¡è¶³ä»¥ä¸Šä»»æ„ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€çš„è¯ï¼Œæˆ‘å°±ä¼šä¿è¯ä½ æ²¡åŠæ³•åœ¨Safe Rustä¸‹æ‹¿åˆ°å¯å˜å€Ÿç”¨<code>&amp;mut T</code>ï¼ˆä¸ä¿¡ä½ å»ç¿»ç¿»æˆ‘çš„APIï¼‰ï¼Œæ‹¿ä¸åˆ°<code>&amp;mut T</code>ä½ å°±æ²¡åŠæ³•ä½œç”¨åˆ°<code>std::mem::swap()</code>ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ä½ è¢«æˆ‘é’‰ä½äº†ï¼ä½ ä»¥ä¸ºrustcçˆ¸çˆ¸ç»™æˆ‘æ–½äº†é­”æ³•ä¹ˆï¼Ÿä½ é”™äº†ï¼Œæˆ‘çš„å·¥ä½œåŸç†å°±æ˜¯è¿™ä¹ˆç®€å•ï¼æ„Ÿè°¢Rustä¸–ç•Œä¸°å¯Œè€Œå¼ºå¤§çš„ç±»å‹ç³»ç»Ÿï¼Œæˆ‘çš„å…¶ä»–å…„å¼Ÿ<strong>Sync</strong>, <strong>Send</strong>ä¹Ÿæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬éƒ½æ²¡æœ‰æ‰€è°“çš„é­”æ³•ï¼</p>
<p>å½“ç„¶æˆ‘è¿˜æ˜¯æä¾›äº†ä¸€ä¸ªunsafeçš„<code>get_unchecked_mut()</code>ï¼Œä¸ç®¡ä½ æœ‰æ²¡æœ‰å®ç°<strong>Unpin</strong>ï¼Œä½ éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ‹¿åˆ°<code>&amp;mut T</code>ï¼Œä½†æ˜¯ä½ éœ€è¦éµå®ˆ<strong>Pinçš„å¥‘çº¦</strong>ï¼ˆå‚è€ƒä¸‹é¢ï¼‰ï¼Œå¦åˆ™å‡ºäº†ä»€ä¹ˆé—®é¢˜åæœè‡ªè´Ÿï¼</p>
<div class="hll"><pre><span></span><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline(always)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_unchecked_mut</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">pointer</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p><strong>Pinçš„å¥‘çº¦ï¼š</strong></p>
<blockquote><p>å¯¹äº<code>Pin&lt;P&lt;T&gt;&gt;</code>,</p>
<ul>
<li>å¦‚æœ<code>P&lt;T&gt;</code>ç¬¦åˆ<strong>Unpin</strong>ï¼Œé‚£<code>P&lt;T&gt;</code>ä»è¢«<strong>Pin</strong>åŒ…è£¹åˆ°è¢«é”€æ¯ï¼Œéƒ½è¦ä¸€ç›´ä¿è¯<code>P&lt;T&gt;</code>ä¸è¢«é’‰ä½</li>
<li>å¦‚æœ<code>P&lt;T</code>&gt;ç¬¦åˆ<strong>!Unpin</strong>ï¼Œé‚£<code>P&lt;T&gt;</code>ä»è¢«<strong>Pin</strong>åŒ…è£¹åˆ°è¢«é”€æ¯ï¼Œéƒ½è¦ä¸€ç›´ä¿è¯<code>P&lt;T&gt;</code>è¢«é’‰ä½</li>
</ul>
</blockquote>
<p>é€šè¿‡ä»¥ä¸Š<strong>Pin</strong>çš„è‡ªè¿°ï¼Œæˆ‘ä»¬å†ç”¨ä¸€å¥è¯æ¥æ€»ç»“ï¼šå¦‚æœä½ å®ç°äº†<strong>Unpin</strong>ï¼Œ<strong>Pin</strong>å¯ä»¥è®©ä½ åœ¨Safe Rustä¸‹æ‹¿åˆ°<code>&amp;mut T</code>ï¼Œå¦åˆ™ä¼šæŠŠä½ åœ¨Safe Rustä¸‹é’‰ä½ï¼ˆä¹Ÿå°±æ˜¯æ‹¿ä¸åˆ°<code>&amp;mut T</code>ï¼‰ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨<strong>Pin</strong>æ¥ä¿®å¤ä¸€ä¸‹ä¸Šé¢è‡ªå¼•ç”¨ç»“æ„ä½“çš„é—®é¢˜ã€‚</p>
<h3 id="ru-he-gou-zao-yi-ge-pin">å¦‚ä½•æ„é€ ä¸€ä¸ªPin</h3><p>é¦–å…ˆæˆ‘ä»¬è¦æ¢³ç†æ¸…æ¥šæ€æ ·æŠŠ<code>P&lt;T&gt;</code>ç”¨<strong>Pin</strong>åŒ…è£¹èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯æ€æ ·æ„é€ ä¸€ä¸ª<strong>Pin</strong>ã€‚æŸ¥çœ‹æ–‡æ¡£ä¼šå‘ç°ä¸»è¦æœ‰è¿™å‡ ç§æ–¹å¼ï¼š</p>
<h4 id="pin-new">Pin::new()</h4><div class="hll"><pre><span></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">Deref</span><span class="o">&lt;</span><span class="n">Target</span>: <span class="nb">Unpin</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline(always)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">pointer</span>: <span class="nc">P</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Safety: the value pointed to is `Unpin`, and so has no requirements</span>
<span class="w">        </span><span class="c1">// around pinning.</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">pointer</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>å¦‚æœä½ çš„<strong>P</strong>æŒ‡å‘çš„<strong>T</strong>æ˜¯<strong>Unpin</strong>çš„è¯ï¼Œä½ å¯ä»¥å®‰å…¨çš„è°ƒç”¨<code>Pin::new()</code>æ„é€ ä¸€ä¸ª<strong>Pin</strong>ã€‚å¯ä»¥çœ‹åˆ°å®ƒåº•å±‚å®é™…ä¸Šæ˜¯è°ƒç”¨unsafeçš„<code>Pin::new_unchecked()</code>ï¼Œä¹‹æ‰€ä»¥<code>Pin::new()</code>æ˜¯å®‰å…¨çš„ï¼Œæ˜¯å› ä¸º<strong>Unpin</strong>çš„æƒ…å†µä¸‹<strong>Pin</strong>çš„â€é’‰ä½â€œæ•ˆæœæ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œè·Ÿæ­£å¸¸çš„æŒ‡é’ˆä¸€æ ·äº†ã€‚</p>
<h4 id="pin-new-unchecked">Pin::new_unchecked()</h4><div class="hll"><pre><span></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">Deref</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[stable(feature = </span><span class="s">&quot;pin&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.33.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline(always)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new_unchecked</span><span class="p">(</span><span class="n">pointer</span>: <span class="nc">P</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Pin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œä½†å®ƒæ˜¯unsafeçš„ã€‚æ ‡ä¸ºunsafeçš„åŸå› æ˜¯ç¼–è¯‘å™¨æ²¡åŠæ³•ä¿è¯ä½¿ç”¨è€…åç»­æ“ä½œä¸€å®šéµå®ˆ<strong>Pinçš„å¥‘çº¦</strong>ã€‚åªè¦æœ‰å­˜åœ¨è¿åå¥‘çº¦çš„å¯èƒ½æ€§ï¼Œå°±å¿…é¡»ç”¨unsafeæ ‡è®°ï¼Œå› ä¸ºè¿™æ˜¯ä½¿ç”¨è€…çš„é—®é¢˜ï¼Œç¼–è¯‘å™¨æ²¡åŠæ³•ä¿è¯ã€‚å¦‚æœä½¿ç”¨è€…é€šè¿‡<code>Pin::new_unchecked()</code>æ„é€ ä¸€ä¸ª<code>Pin&lt;P&lt;T&gt;&gt;</code>ä¹‹å<strong>Pin</strong>çš„ç”Ÿå‘½å‘¨æœŸç»“æŸäº†ï¼Œä½†<code>P&lt;T&gt;</code>ä¾ç„¶å­˜åœ¨ï¼Œåˆ™åç»­æ“ä½œä¾ç„¶å¯èƒ½è¢«moveï¼Œé€ æˆå†…å­˜ä¸å®‰å…¨ã€‚</p>
<div class="hll"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">move_pinned_ref</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">b</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// This should mean the pointee `a` can never move again.</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">mem</span>::<span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// The address of `a` changed to `b`&#39;s stack slot, so `a` got moved even</span>
<span class="w">    </span><span class="c1">// though we have previously pinned it! We have violated the pinning API contract.</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<h4 id="qi-ta">å…¶ä»–</h4><p>åŒ…æ‹¬<code>Box::pin()</code>, <code>Rc::pin()</code>å’Œ<code>Arc::pin()</code>ç­‰ï¼Œåº•å±‚éƒ½æ˜¯è°ƒç”¨ä¸Šé¢çš„<code>Pin::new_unchecked()</code>ï¼Œä¸å†é˜è¿°ã€‚</p>
<h3 id="pinde-ying-yong">Pinçš„åº”ç”¨</h3><p><strong>Pin</strong>å¯ä»¥åˆ†ä¸ºæ ˆä¸Šè¿˜æ˜¯å †ä¸Šï¼Œå–å†³äºä½ è¦<strong>Pin</strong>çš„é‚£ä¸ªæŒ‡é’ˆ<strong>P</strong>æ˜¯åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Šã€‚æ¯”å¦‚<code>Pin&lt;&amp;mut  T&gt;</code>æ˜¯æ ˆä¸Šï¼Œ<code>Pin&lt;Box&lt;T&gt;&gt;</code>æ˜¯åœ¨å †ä¸Šã€‚</p>
<h4 id="pindao-zhan-shang">Pinåˆ°æ ˆä¸Š</h4><div class="hll"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="n">PhantomPinned</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_marker</span>: <span class="nc">PhantomPinned</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">txt</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">a</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">b</span>: <span class="nc">std</span>::<span class="n">ptr</span>::<span class="n">null</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">_marker</span>: <span class="nc">PhantomPinned</span><span class="p">,</span><span class="w"> </span><span class="c1">// This makes our type `!Unpin`</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">init</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">self_ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self_ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">a</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">get_ref</span><span class="p">().</span><span class="n">a</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">b</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Test</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;test1&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">Test</span>::<span class="n">init</span><span class="p">(</span><span class="n">test1</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">test2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Test</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;test2&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">Test</span>::<span class="n">init</span><span class="p">(</span><span class="n">test2</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a: {}, b: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Test</span>::<span class="n">a</span><span class="p">(</span><span class="n">test1</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()),</span><span class="w"> </span><span class="n">Test</span>::<span class="n">b</span><span class="p">(</span><span class="n">test1</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">swap</span><span class="p">(</span><span class="n">test1</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(),</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">get_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a: {}, b: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Test</span>::<span class="n">a</span><span class="p">(</span><span class="n">test2</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()),</span><span class="w"> </span><span class="n">Test</span>::<span class="n">b</span><span class="p">(</span><span class="n">test2</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>æˆ‘ä»¬å°è¯•æŠŠ<code>&amp;mut Test</code>é’‰åœ¨æ ˆä¸Šï¼Œç„¶åå°è¯•å»è°ƒç”¨<code>get_mut()</code>ä½œä¸ºå‚æ•°ä¼ ç»™<code>std::mem::swap()</code>ï¼Œå‘ç°ç¼–è¯‘ä¸é€šè¿‡ã€‚Rustç¼–è¯‘å™¨ä»ç¼–è¯‘é˜¶æ®µå°±é˜»æ­¢æˆ‘ä»¬å»çŠ¯é”™äº†ã€‚</p>
<pre><code>  |     std::mem::swap(test1.get_mut(), test2.get_mut());
  |                          ^^^^^^^ within `Test`, the trait `Unpin` is not implemented for `PhantomPinned`
  |
</code></pre>
<h4 id="pindao-dui-shang">Pinåˆ°å †ä¸Š</h4><div class="hll"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="n">PhantomPinned</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_marker</span>: <span class="nc">PhantomPinned</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">txt</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">a</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">b</span>: <span class="nc">std</span>::<span class="n">ptr</span>::<span class="n">null</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">_marker</span>: <span class="nc">PhantomPinned</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">boxed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">self_ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">boxed</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">boxed</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">get_unchecked_mut</span><span class="p">().</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self_ptr</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">boxed</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">a</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">get_ref</span><span class="p">().</span><span class="n">a</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">b</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Test</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;test1&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">test2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Test</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;test2&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a: {}, b: {}&quot;</span><span class="p">,</span><span class="n">test1</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">a</span><span class="p">(),</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">b</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="c1">// std::mem::swap(test1.get_mut(), test2.get_mut());</span>
<span class="w">    </span><span class="c1">// std::mem::swap(&amp;mut *test1, &amp;mut *test2);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a: {}, b: {}&quot;</span><span class="p">,</span><span class="n">test2</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">a</span><span class="p">(),</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">b</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>è¿™é‡Œä½¿ç”¨<code>Box::pin()</code>æŠŠTesté’‰åœ¨äº†å †ä¸Šã€‚å–æ¶ˆæ³¨é‡Šä»»æ„ä¸€è¡Œéƒ½ä¼šç¼–è¯‘ä¸é€šè¿‡ï¼Œå› ä¸ºTestæ˜¯<strong>!Unpin</strong>çš„ã€‚</p>
<h4 id="future">Future</h4><div class="hll"><pre><span></span><span class="cp">#[stable(feature = </span><span class="s">&quot;futures_api&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.36.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>æ¥ä¸‹æ¥è®²ä¸€ä¸‹<strong>Pin</strong>ç›®å‰æœ€é‡è¦çš„ä¸€ä¸ªåº”ç”¨ï¼š<strong>Future</strong>ã€‚å½“åˆ2018å¹´å®˜æ–¹å¼‚æ­¥ç»„å¼•å…¥Pin APIçš„åˆè¡·å°±æ˜¯ä¸ºäº†è§£å†³<strong>Future</strong>å†…éƒ¨è‡ªå¼•ç”¨çš„é—®é¢˜ã€‚å› ä¸ºasync/awaitå°±æ˜¯é€šè¿‡<strong>Generator</strong>å®ç°çš„ï¼Œ<strong>Generator</strong>æ˜¯é€šè¿‡åŒ¿åç»“æ„ä½“å®ç°çš„ã€‚å¦‚æœasyncå‡½æ•°ä¸­å­˜åœ¨è·¨awaitçš„å¼•ç”¨ï¼Œä¼šå¯¼è‡´åº•å±‚<strong>Generator</strong>å­˜åœ¨è·¨yieldçš„å¼•ç”¨ï¼Œé‚£æ ¹æ®<strong>Generator</strong>ç”Ÿæˆçš„åŒ¿åç»“æ„ä½“å°±ä¼šæ˜¯ä¸€ä¸ªè‡ªå¼•ç”¨ç»“æ„ä½“ï¼ç„¶åè¿™ä¸ªè‡ªå¼•ç”¨ç»“æ„ä½“ä¼š<code>impl Future</code>ï¼Œå¼‚æ­¥çš„Runtimeåœ¨è°ƒç”¨<code>Future::poll()</code>å‡½æ•°æŸ¥è¯¢çŠ¶æ€çš„æ—¶å€™ï¼Œéœ€è¦ä¸€ä¸ªå¯å˜å€Ÿç”¨ï¼ˆå³<code>&amp;mut Self</code>ï¼‰ã€‚å¦‚æœè¿™ä¸ª<code>&amp;mut Self</code>ä¸åŒ…è£¹åœ¨<strong>Pin</strong>é‡Œé¢çš„è¯ï¼Œå¼€å‘è€…è‡ªå·±<code>impl Future</code>å°±ä¼šåˆ©ç”¨<code>std::mem::swap()</code>ä¹‹ç±»çš„å‡½æ•°moveæ‰<code>&amp;mut Self</code>ï¼æ‰€ä»¥è¿™å°±æ˜¯<strong>Future</strong>çš„<code>poll()</code>å¿…é¡»è¦ä½¿ç”¨<code>Pin&lt;&amp;mut Self&gt;</code>çš„åŸå› ã€‚</p>
<div class="hll"><pre><span></span><span class="c1">// è¿™ä¸ªasyncå—ä¸­å­˜åœ¨è·¨awaitçš„å€Ÿç”¨ï¼</span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">to_borrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">to_borrow</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SomeResource</span>::<span class="n">some_task</span><span class="p">().</span><span class="k">await</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{} world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">borrowed</span><span class="p">);</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
<p>å½“ç„¶è¿˜æœ‰éå¸¸é‡è¦çš„ä¸€ç‚¹ä¸èƒ½å¿˜äº†ï¼<strong>Pin</strong>åªå¯¹å®ç°<strong>!Unpin</strong>çš„ç±»å‹æ‰æœ‰é’‰ä½çš„æ•ˆæœï¼Œè¿™ä¸ª<code>impl Future</code>çš„åŒ¿åç»“æ„ä½“æœ‰<code>impl !Unpin</code>å—ï¼Ÿå½“ç„¶æœ‰ï¼Œå‰é¢è¯´äº†åªæœ‰å‡ ç§ç‰¹ä¾‹æ˜¯é»˜è®¤ <strong>!Unpin</strong>ï¼Œè¿™ä¸ªåŒ¿åç»“æ„ä½“å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</p>
<div class="hll"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_generator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gen</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span>::<span class="n">Return</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nc">Generator</span><span class="o">&lt;</span><span class="n">ResumeTy</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[rustc_diagnostic_item = </span><span class="s">&quot;gen_future&quot;</span><span class="cp">]</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">GenFuture</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Generator</span><span class="o">&lt;</span><span class="n">ResumeTy</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// We rely on the fact that async/await futures are immovable in order to create</span>
<span class="w">    </span><span class="c1">// self-referential borrows in the underlying generator.</span>
<span class="w">    </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Generator</span><span class="o">&lt;</span><span class="n">ResumeTy</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">!</span><span class="nb">Unpin</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GenFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Generator</span><span class="o">&lt;</span><span class="n">ResumeTy</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GenFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span>::<span class="n">Return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// SAFETY: Safe because we&#39;re !Unpin + !Drop, and this is just a field projection.</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">map_unchecked_mut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Resume the generator, turning the `&amp;mut Context` into a `NonNull` raw pointer. The</span>
<span class="w">            </span><span class="c1">// `.await` lowering will safely cast that back to a `&amp;mut Context`.</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">gen</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">ResumeTy</span><span class="p">(</span><span class="n">NonNull</span>::<span class="n">from</span><span class="p">(</span><span class="n">cx</span><span class="p">).</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">GeneratorState</span>::<span class="n">Yielded</span><span class="p">(())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">GeneratorState</span>::<span class="n">Complete</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">GenFuture</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>åˆ’é‡ç‚¹<code>impl&lt;T: Generator&lt;ResumeTy, Yield = ()&gt;&gt; !Unpin for GenFuture&lt;T&gt; {}</code>ï¼Œåªæœ‰äº²çœ¼æ‰€è§æ‰èƒ½è®©å¤§å®¶ä¿¡æœã€‚</p>
<h3 id="qi-ta">å…¶ä»–</h3><p><strong>Pin</strong>é™¤äº†ä¸Šé¢è¿™äº›å†…å®¹å¤–è¿˜æœ‰å…¶ä»–å‡ ä¸ªæ¦‚å¿µï¼Œæ¯”å¦‚Pin projection, Structural pinå’ŒNon-structural pinï¼Œç¬”è€…è‡ªå·±ç”¨çš„ä¹Ÿä¸å¤šï¼Œè¯¦ç»†å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£æˆ–æŸ¥é˜…å…¶ä»–èµ„æ–™ã€‚</p>
<p><a href="https://docs.rs/futures">futures-rs</a>ä¸­è¿˜æœ‰ä¸å°‘å’Œ<strong>Pin</strong>æœ‰å…³çš„APIï¼Œå¦‚æœæ·±å…¥ä½¿ç”¨futures-rsçš„è¯ï¼Œä¸å¯é¿å…çš„éœ€è¦é¢‘ç¹çš„å’Œ<strong>Pin</strong>æ‰“äº¤é“ã€‚</p>
<p><img src="/blog/rust-pin-unpin/features-rs.png" alt=""></p>
<h3 id="zong-jie">æ€»ç»“</h3><p>ä¸‹é¢æ˜¯æ‘˜æŠ„è‡ªå®˜æ–¹Async Bookä¸Šå…³äº<strong>Pin</strong>çš„<a href="https://rust-lang.github.io/async-book/04_pinning/01_chapter.html#summary">é»„é‡‘8æ¡</a>ä½œä¸ºæ€»ç»“ï¼Œè¿™äº›å‡ ä¹å°±æ˜¯<strong>Pin</strong> APIçš„å…¨éƒ¨äº†ã€‚</p>
<blockquote><ul>
<li><p>If T: Unpin (which is the default), then Pin&lt;'a, T&gt; is entirely equivalent to &amp;'a mut T. in other words: Unpin means it's OK for this type to be moved even when pinned, so Pin will have no effect on such a type.</p>
</li>
<li><p>Getting a &amp;mut T to a pinned T requires unsafe if T: !Unpin.</p>
</li>
<li><p>Most standard library types implement Unpin. The same goes for most "normal" types you encounter in Rust. A Future generated by async/await is an exception to this rule.</p>
</li>
<li><p>You can add a !Unpin bound on a type on nightly with a feature flag, or by adding std::marker::PhantomPinned to your type on stable.</p>
</li>
<li><p>You can either pin data to the stack or to the heap.</p>
</li>
<li><p>Pinning a !Unpin object to the stack requires unsafe</p>
</li>
<li><p>Pinning a !Unpin object to the heap does not require unsafe. There is a shortcut for doing this using Box::pin.</p>
</li>
<li><p>For pinned data where T: !Unpin you have to maintain the invariant that its memory will not get invalidated or repurposed from the moment it gets pinned until when drop is called. This is an important part of the pin contract.</p>
</li>
</ul>
</blockquote>
<p>2018å¹´Rustå¼‚æ­¥ç»„çš„æ ¸å¿ƒæˆå‘˜@withoutboatsåœ¨ä»–<a href="https://without.boats/blog">ä¸ªäººåšå®¢</a>åˆ†äº«äº†ç¨³å®šasync/awaitçš„æ•´ä¸ªå¿ƒè·¯å†ç¨‹ï¼Œæ„Ÿè§‰è¿™ä¸€è·¯ä¹Ÿæ˜¯å……æ»¡æ›²æŠ˜ã€‚æ¯”å¦‚<strong>Pin</strong>åˆšå¼€å§‹è¿˜éœ€è¦åŒºåˆ†<strong>Pin</strong>ï¼Œ<strong>PinMut</strong>ï¼Œ<strong>PinBox</strong>ç­‰ï¼Œç°åœ¨ç²¾ç®€åˆ°åªéœ€è¦ä¸€ä¸ª<code>Pin&lt;P&gt;</code>å°±èƒ½æå®šã€‚è¿˜æœ‰æ›´æ—©çš„æ—¶å€™è¿˜è®¡åˆ’å¼•å…¥ä¸€ä¸ªå«<strong>Move</strong>çš„traitæ¥æ ‡è®°è¯¥ç±»å‹æ˜¯å¦å¯ä»¥moveç­‰ç­‰ã€‚æˆ‘è¿™ç¯‡æ–‡ç« é‡Œé¢çš„ä»£ç åŸºäº1.48ç‰ˆï¼Œä¸ç¡®å®š<strong>Pin</strong>ä»¥åä¼šä¸ä¼šæœ‰æ›´æ–°ï¼Œè€Œä¸”<strong>Pin</strong>ç›®å‰è¿˜å­˜åœ¨ä¸€ä¸ª<a href="https://internals.rust-lang.org/t/unsoundness-in-pin/11311">unsoundnessçš„é—®é¢˜</a>ã€‚ä¸ç®¡æ€æ ·ï¼Œä¸€åˆ‡ç®€å•ä¼˜é›…çš„è®¾è®¡èƒŒåä¸€å®šéšè—ç€å¤æ‚å’Œè‰°è¾›ï¼Œæ„Ÿè°¢Rustå®˜æ–¹è¿‡å»çš„åŠªåŠ›ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿæœ‰å†…å­˜å®‰å…¨ã€æ— ç•å¹¶å‘å’Œç¬¦åˆäººä½“å·¥ç¨‹çš„ç¼–ç¨‹ä½“éªŒï¼</p>

            
        </div>
    </div>
    
    
    
    <div class="table-of-content">
        <div class="sticky">
            <b class="pipe-title">Table of content</b>
            <ul class="toc">
                
                <li>
                    <a href="#gai-nian">æ¦‚å¿µ</a>
                    
                </li>
                
                <li>
                    <a href="#dao-di-shi-yao-shi-move">åˆ°åº•ä»€ä¹ˆæ˜¯moveï¼Ÿ</a>
                    
                </li>
                
                <li>
                    <a href="#zi-yin-yong-jie-gou-ti-de-move">è‡ªå¼•ç”¨ç»“æ„ä½“çš„move</a>
                    
                </li>
                
                <li>
                    <a href="#gen-yuan-shi-shi-yao">æ ¹æºæ˜¯ä»€ä¹ˆï¼Ÿ</a>
                    
                </li>
                
                <li>
                    <a href="#pinshan-liang-deng-chang">Piné—ªäº®ç™»åœº</a>
                    
                </li>
                
                <li>
                    <a href="#ru-he-gou-zao-yi-ge-pin">å¦‚ä½•æ„é€ ä¸€ä¸ªPin</a>
                    
                    <ul>
                <li>
                    <a href="#pin-new">Pin::new()</a>
                    
                </li>
                
                <li>
                    <a href="#pin-new-unchecked">Pin::new_unchecked()</a>
                    
                </li>
                
                <li>
                    <a href="#qi-ta">å…¶ä»–</a>
                    
                </li>
                </ul>
                    
                </li>
                
                <li>
                    <a href="#pinde-ying-yong">Pinçš„åº”ç”¨</a>
                    
                    <ul>
                <li>
                    <a href="#pindao-zhan-shang">Pinåˆ°æ ˆä¸Š</a>
                    
                </li>
                
                <li>
                    <a href="#pindao-dui-shang">Pinåˆ°å †ä¸Š</a>
                    
                </li>
                
                <li>
                    <a href="#future">Future</a>
                    
                </li>
                </ul>
                    
                </li>
                
                <li>
                    <a href="#qi-ta">å…¶ä»–</a>
                    
                </li>
                
                <li>
                    <a href="#zong-jie">æ€»ç»“</a>
                    
                </li>
                
            </ul>
        </div>
    </div>
    
</div>
<script src="/static/app.js?h=f1487eff"></script>
</body>
